# äº¤æ¥æ–‡æ¡£



### é¢„ç®—

Moudule:rh_account_budget

1.`conf`

 	å­˜æ”¾redisé…ç½®æ–‡ä»¶

2.`contrlollers`

â€‹	==main.py==  class SyncBudgetReport:

â€‹	Route:/api/get_crossovered_budget  : é¢„ç®—æ±‡æ€»æƒ…å†µ  è¿”å›:`json`

â€‹	Route:/api/get_account_budget_post: é¢„ç®—çŠ¶å†µæ±‡æ€»è¡¨

3.`lib`

â€‹	==jwt_utils.py== :å°è£…æ¥å£åŠ å¯†æœºåˆ¶

â€‹	 

```python
def sha256base64
#å¯†é’¥åŠ å¯†ç®—æ³•
def verify_token
#æ ¡éªŒtokenè£…é¥°å™¨
```

â€‹	 ==redislib.py== ï¼šå°è£…äº†æ‰€æœ‰redisçš„è¿æ¥æ± å’Œæ¥å£

```python
class ExportRedis:
    def insert_redis_queue(self, queue, params_dict):
        '''ç”±å·¦å‘å³ğŸ‘‰æ’å…¥List'''
        self.cursor.lpush(queue, json.dumps(params_dict))

    def rpop_redis_queue(self, queue):
        '''ä»å³å‘å·¦å¼¹å‡º return []'''
        return self.cursor.rpop(queue)
    
    def range_queue(self, queue):
        # æŸ¥è¯¢åˆ—è¡¨ä¸­æ‰€æœ‰çš„é”®å€¼
        return self.cursor.lrange(queue, 0, -1)
```



4. `Models`

    ==account_budget_modify.py==:ä¸»è¦åŠŸèƒ½ç‚¹ï¼šè¡¨ï¼š==crossovered.budget.lines==é¢„ç®—æ˜ç»†è¡¨

    planned_amount  è®¡åˆ’é‡‘é¢ practical_amount å®é™…é‡‘é¢  ==new_practical_amount==  æ ¹æ®practical_amountå®é™…é‡‘é¢writeå›å¡«    balance ä½™é¢ã€‚show_color ï¼šæ§åˆ¶åˆ—è¡¨å˜çº¢

    done_per å®Œæˆç‡ 

    ==def _compute_practical_amount== è®¡ç®—å®é™…é‡‘é¢ï¼Œæ ¹æ®åˆ†æè´¦æˆ·æ˜ç»†ä¸­ è¯¥åˆ†æè´¦æˆ·åœ¨æ—¥æœŸåŒºé—´å†…æœ‰çš„`é¢„ç®—çŠ¶å†µ` è¿›è¡ŒSUMè®¡ç®—

    

    ==budget_hr_expense.py== ï¼šç»§æ‰¿hr.expense.sheet å¯¹è´¹ç”¨å•æ®è¿›è¡Œé¢„ç®—è¶…æ”¯`é¢„è­¦å¼¹å‡ºæ¡†`,åœ¨do_sumbitå’Œdo_approved å–é¢„ç®—çš„ä½™é¢å’Œå½“å‰åœ¨å¾…æ‰¹å’Œå®Œæˆçš„å•æ®å‘ç”Ÿé¢è¿›è¡Œæ¯”è¾ƒï¼Œ==è¶…çš„æ˜ç»†è¡Œå˜çº¢å¹¶ä¸”å¼¹å‡ºæç¤ºæ¡†==

    ```python
    class HrExpense
    module_budget_installed #æ£€æŸ¥é¢„ç®—æ¨¡å—æ˜¯å¦å®‰è£…ï¼Œæœ‰åˆ†æè´¦æˆ·å¿…å¡«
    excess_color  #è®¡ç®—å­—æ®µ compute_excess_color
    	def compute_module_budget_installed(self):
            for record in self:
                module = self.env['ir.module.module'].sudo().search([('name', '=', 		'rh_account_budget')])
                if record.payment_mode == 'own_account': #å±äºæŠ¥é”€ç±»å‹
                  #  ä¸‹é¢æ ¹æ®æƒ…å†µåˆ†é¢„ç®—å†…/é¢„ç®—å¤–
                else: #è‡ªåŠ¨æ‰£æ¬¾
                    record.module_budget_installed = False
         
    	def  compute_excess_color #æ§åˆ¶æ˜ç»†è¡Œå˜çº¢
        
        def action_to_analytic_formï¼š#è·³è½¬åˆ°å¯¹åº”çš„åˆ†æè´¦æˆ·ç•Œé¢
        
        def edit_expense_line_analytic :#ä¿®æ”¹åˆ†æè´¦æˆ·ä¸Šanalytic_account_id
            
    ```

    ==inherit_analytic_account.py== ï¼šå¯¹åˆ†æè´¦æˆ·åŠŸèƒ½ç»§æ‰¿

    â€‹	`department_ids`ï¼šéƒ¨é—¨  `user_ids`ï¼šå‘˜å·¥    `department_user_ids`ï¼šéƒ¨é—¨ä¸‹çš„å‘˜å·¥

    â€‹	æ ¹æ®éƒ¨é—¨é€‰æ‹©ä¸‹å±å‘˜å·¥å¯è§ï¼Œæˆ–è€…ç›´æ¥é€‰æ‹©å‘˜å·¥ï¼Œé™åˆ¶è®°å½•è§„åˆ™

    â€‹	def compute_user_ids :è®¡ç®—éƒ¨é—¨çš„å‘˜å·¥

    ```python
    #é‡å†™åˆ†ç»„å‡½æ•°ã€‚ç”¨æ¥è®¡ç®—é¢„ç®—çš„å®é™…é‡‘é¢ã€å ç”¨é‡‘é¢ã€ä½™é¢
    def read_group(self, domain, fields, groupby, offset=0, limit=None, orderby=False, lazy=True):
            res = super(AccountAnalyticAccount, self).read_group(domain, fields, groupby, offset=offset, limit=limit,
                                                                 orderby=orderby, lazy=lazy)
            for r in res:
                domain = r.get('__domain', [])
                records = self.search(domain)
                r['budget_planned_amount'] = sum(records.mapped('budget_planned_amount')) or 0.0
                r['budget_amount'] = sum(records.mapped('budget_amount')) or 0.0
                r['budget_balance'] = sum(records.mapped('budget_balance')) or 0.0
                r['occupy_amount'] = sum(records.mapped('occupy_amount')) or 0.0 #å ç”¨é‡‘é¢
    
            return res
        
    def summary_analytic_records(self): #è®¡ç®—è¯¥åˆ†æè´¦æˆ·å…³è”çš„è´¹ç”¨å•æ®çš„å‘ç”Ÿé¢
    def click_details_windows(self):#è·³è½¬æŒ‰é’®ï¼ŒåµŒå¥—ä¸Šé¢çš„æ–¹æ³•ï¼Œæ¯æ¬¡ç‚¹å‡»åˆ é™¤æ—§çºªå½•ï¼Œç”Ÿæˆæ–°çºªå½•ï¼Œç­›é€‰å½“å‰çš„åˆ†æè´¦æˆ·
    ```

    â€‹	

    

5. `wizard`

    ä¸´æ—¶è¡¨æä¾›å‘å¯¼åŠŸèƒ½

    ==wizard_analysis_examine_details.py== åˆ†æè´¦æˆ·ä½¿ç”¨çš„è¯¦æƒ…

    ==wizard_batch_dept_users.py==:æ›´æ–°éƒ¨é—¨ä¸‹çš„å‘˜å·¥

    ==wizard_edit_expense_line_analytic.py==ï¼šä¿®æ”¹åˆ†æè´¦æˆ·æ˜ç»†è¡Œ

    ==wizard_hr_expense_sheet_budget.py==:è´¹ç”¨å®¡æ‰¹å’Œæäº¤ã€‚åˆ¤æ–­æ˜¯å¦è¶…æ”¯é‡‘è¶





### é‡‘è¶

`Module`:rh_kingdee_port

1. Data:`kingdee_ir_corn.xml`ï¼šå®šæ—¶ä»»åŠ¡ï¼š`è´¹ç”¨å•æ®æ¨é€è´¦æ— å¿§`,`æ”¶ä»˜æ¬¾å•æ®æ¨é€è´¦æ— å¿§`,`å†…éƒ¨è½¬è´¦å•æ®æ¨é€è´¦æ— å¿§`

    `kingdee_setting.yml`ï¼šè‡ªåŠ¨åˆ›å»ºé‡‘è¶é…ç½®å‚æ•°

  2.Libï¼š

â€‹		`redislib.py`: def handle_redis_tokenå­˜å‚¨è®¾ç½®tokençš„æœ‰æ•ˆæ—¶é•¿ä¸º4å°æ—¶ï¼Œè¿‡æœŸè‡ªåŠ¨åˆ é™¤

â€‹	3.Models:

â€‹		==rh_kingdee_port.py==é›†æˆé‡‘è¶æ‰€æœ‰æ¨¡å‹å’Œæ¥å£

â€‹		==rh_kingdee_send_logs.py==ï¼šé‡‘è¶åŒæ­¥æ—¥å¿—

â€‹		==account_payment_interface.py==ï¼šé›†æˆæ”¶ä»˜æ¬¾æ¨é€åŠŸèƒ½

â€‹		==inhert_hr_sheet.py==ï¼šè´¹ç”¨æ¨é€

â€‹		==rh_inherit_company.py==ï¼šè¾“å…¥å…¬å¸åç§°ï¼Œè·å–å¸æ— å¿§å¯¹åº”çš„å®¢æˆ·ç¼–å·ç”¨äºåŒæ­¥æ¥å£

â€‹		==rh_kingdee_category.py==ï¼šé‡‘è¶ç¥¨æ®ç±»å‹å’Œå‡­è¯æ¨¡ç‰ˆå­˜æ”¾çš„æ¨¡å‹è¡¨

â€‹		`é‡‘è¶é…ç½®`æ˜¯é€šè¿‡yamlæ–‡ä»¶å¯¼å…¥ç”Ÿæˆçš„

â€‹	4.`wizard`

â€‹		push_account_sheet_wizard.py ï¼šè´¹ç”¨æ¨é€å‘å¯¼

â€‹		push_expense_sheet_wizard.pyï¼šæ”¶ä»˜æ¬¾å‘å¯¼

```python
class Kingdee_Port_set(models.Model):
    def test_kingdee_connection(self):#æµ‹è¯•é“¾æ¥å¹¶å°†tokenä¿å­˜åˆ°rediså½“ä¸­
    def check_redis_token(self) #æ£€æŸ¥tokeèƒ½æœ‰æ•ˆæ€§ï¼Œæœ‰åˆ™è·å–ï¼Œæ— åˆ™é‡æ–°è°ƒç”¨test_kingdee_connection
    def get_kingdee_category(self)#è·å–ç¥¨æ®ç±»å‹
    def get_account_rule(self):#è·å–å‡­è¯æ¨¡ç‰ˆ
    def batch_push_documents(self):#æ¨é€å•æ®åˆ°å¸æ— å¿§æ™ºèƒ½è®°è´¦
    def get_report_account(self):#è·å–é“¶è¡Œç§‘ç›®
    
```



### ç™¾åº¦è¡Œæ”¿ç¼–å—

â€‹	1.`Models`:address_maintenance.py

â€‹		è°ƒå–APiæ¥å£ï¼Œåˆ†åˆ«ä¸ºçœã€å¸‚ã€åŒºã€ä¹¡é•‡è¡—é“(ç›®å‰åªæœ‰åŒ—äº¬å’Œä¸Šæµ·)å†™å…¥åç§°å’Œè¡Œæ”¿ç¼–å—

â€‹	2.`Views`:address_import.xml

â€‹		é™åˆ¶åŸæ¨¡å‹çš„åˆ›å»ºä¿®æ”¹



### çŸ­ä¿¡å¹³å°

â€‹	1.`Models`:compressed_link.py

â€‹		å¤§æ±‰ä¸‰é€šçŸ­é“¾æ¥ def set_short_url

â€‹		inherit_workflow_config_settings.py ç»§æ‰¿åŸºç¡€é…ç½®æ¨¡å‹ï¼Œå†™å…¥çŸ­ä¿¡URLï¼Œè´¦å·ã€å¯†ç 

â€‹		send_message.py ï¼šçŸ­ä¿¡æ¨¡ç‰ˆå’Œæ¥å£è°ƒç”¨

### è‡ªç”±ç­¾

1.`Models`

â€‹	`Fields`:sign_process_id :ç­¾ç½²æµç¨‹IDï¼Œsignatory_idsï¼šç­¾ç½²æ–¹åˆ—è¡¨ï¼Œcurrent_signatory_idï¼šå½“å‰ç­¾ç½²äººï¼Œ

â€‹	history_signatory_idï¼šå‘èµ·ç­¾ç½²çš„äººï¼ˆç¬¬ä¸€ï¼‰

- ==free_sale.py==:ç”µå­ç­¾çº¦æ·»åŠ ç­¾ç½²æ–¹ 

```python
def init_send_sign_msg(self):#å½“å‰ç­¾ç½²äººå¿…é¡»æ˜¯ä¼ä¸šå½“å‰ç­¾ç½²äººï¼Œåˆå§‹åŒ–ç­¾ç½²çš„ç¯å¢ƒï¼Œ`å¤šç­¾`å¿…é¡»æ³•äººç¡®è®¤çŸ­ä¿¡ï¼Œ`å•ç­¾`æ— éœ€ç¡®è®¤
    if party_partner_obj.org_id.id != False: #ä»£è¡¨ä¼ä¸šç­¾ç½²
        if sign_partner_obj.id != legal_person_partner_obj.id: #å½“å‰ç­¾ç½²äººä¸æ˜¯æ³•äºº
            flag = True
            if signing_method == 'multi_signature': #å¤šç­¾
                party_obj.auth_state = 'start_auth'
                result = tool.send_msg_to_legal_person_for_sign(model_str, record_id, party_obj.id,time_stamp, sign_partner_obj.id)
    else:
        party_obj.auth_state = 'person' #ä¸ªäººç­¾ç½²
                                                                

def send_sign_msg(self):#å‘èµ·ç­¾çº¦è°ƒç”¨eç­¾å®é™é»˜ç­¾ç½²	 
                   flow_num,body_json=util.util_send_sale_signature(data,name,sign_list,'sign_free_sale',model='free.sale',record_id=self.id) #æ„é€ ç­¾ç½²æ–¹åˆ—è¡¨æ‰€éœ€çš„ç¯å¢ƒå˜é‡
        field_list = handler.find_sign_field_based_on_flow_num(flow_num=flow_num,lighthouse=lighthouse)
        
```



- ==def send_sign_msg==ï¼šä¸ºè‡ªç”±ç­¾åˆ†ç±»ä¸ºï¼Œå•ç­¾å’Œå¤šç­¾ï¼Œåœ¨XML contextä¸­é»˜è®¤`def create_signer`å•ç­¾è‡ªåŠ¨å¸¦å‡ºå½“å‰å…¬å¸çš„å½“å‰ç­¾ç½²äººï¼Œ`def action_opt_sign_warning`æ²¡æœ‰ç­¾ç½²äººå¼¹å‡ºæé†’ ï¼Œ`def do_submit`ç›´æ¥åˆ›å»ºç­¾ç½²æ–¹ï¼Œ`notify_signer_msg`:èµ°å®Œå®¡æ‰¹æµå‘é€çŸ­ä¿¡

- `single_sign.py`: å­—æ®µï¼šsigning_method ï¼šã€'single_sign':å•ç­¾ï¼Œ'multi_signature':å¤šç­¾ã€‘

     `def create_signer`:å•ç­¾è‡ªåŠ¨åˆ›å»ºç­¾ç½²æ–¹åˆ—è¡¨æ–¹æ³•

    `def _compute_belong_singer`:æ ¹æ®current_signatory_id,åˆ¤æ–­å½“å‰ç­¾ç½²äººå’Œç™»å½•idæ˜¯å¦ä¸€è‡´

- `free_sign_popup_reminder.py`:ç­¾ç½²æ–¹åˆ—è¡¨ä¸ºç©ºæ—¶ï¼Œå¼¹å‡ºå‘å¯¼çš„wizardæ–¹æ³•

2.`Controllers`

â€‹	==controllers.py==: `/sign/process/free_sale`è¿™ä¸ªè·¯ç”±æ˜¯ç”¨æ¥è‡ªç”±ç­¾ç½²å›è°ƒï¼Œæ›´æ”¹æœ¬åœ°çš„çŠ¶æ€

